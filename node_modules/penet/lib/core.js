var queryString = require('querystring'),
    url = require("url")
    logger = require("./util").logger;

/**
 * @param requestData
 * for requestData as style
 *  example
 *  { 'message[message][message]': '[信息]' }
 *
 *  to data as style
 *  {
 *      message: {
 *          "message": {
 *              message: "[信息]"
 *          }
 *      }
 *  }
 * @returns the data has been handled
 */
var data2JSON = function(requestData){
    var params = {};
    var loop = function(keys, value, index, params){
        if(index == keys.length -1){
            params = value;
            return params;
        }else {
            params = params || {};
            params[keys[index+1]] = loop(keys, value, index +1, params[keys[index+1]]);
            return params;
        }
    }
    for(key in requestData){
        var keys = key.split(/\[|\]\[|\]/g);
        if(keys[keys.length - 1] == "") keys = keys.slice(0,keys.length - 1);
        params[keys[0]] = loop(keys, requestData[key], 0, params[keys[0]]);
    }
    return params;
}

/**
 *
 * @type {{doMessage: Function}}
 */
module.exports = {
    doMessage: function(incomingMessage, end){
        logger.info("Do InconmingMessage Begining")
        incomingMessage.setEncoding("utf8");
        logger.info("IncomingMessage Method: " + incomingMessage.method);
        if (incomingMessage.method == "GET"){
            logger.info(url.parse(incomingMessage.url).query);
            incomingMessage.params = data2JSON(queryString.parse(url.parse(incomingMessage.url).query));
            logger.info("IncomingMessage params: " + incomingMessage.params);
            console.log(JSON.stringify(incomingMessage.params));
            end();
        } else if(incomingMessage.method == "POST"){
            var requestData = "";
            incomingMessage.addListener("data", function(dataChunk) {
                requestData += dataChunk;
            });
            incomingMessage.addListener("end", function() {
                incomingMessage.params = data2JSON(queryString.parse(requestData));
                logger.info("IncomingMessage params: " + incomingMessage.params);
                logger.info(JSON.stringify(incomingMessage.params));
                end();
            });
        }
    }
}